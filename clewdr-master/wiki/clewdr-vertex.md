### 教程：在 Google Cloud 控制台创建服务账号并配置 ClewdR 进行 Vertex AI 集成

本教程将指导你如何在 Google Cloud 控制台中创建服务账号，生成 JSON 凭证，并将凭证配置到 ClewdR 中以实现与 Vertex AI 的集成，最后在酒馆界面完成反向代理设置和模型连接。

#### 前置条件
- 你已拥有 Google Cloud 账户，并创建了一个项目。
- 你的服务器上已成功部署并运行 ClewdR（参考前一篇教程）。
- 确保你有权限在 Google Cloud 控制台中管理服务账号和 Vertex AI。

#### 步骤 1：打开 Google Cloud 控制台并选择项目
1. 登录到 [Google Cloud 控制台](https://console.cloud.google.com/)。
2. 在页面顶部下拉菜单中，选择你希望配置 Vertex AI 的正确项目。如果没有项目，请先创建一个。

#### 步骤 2：导航到服务账号页面
1. 在控制台左侧导航菜单中，点击 **IAM 和管理**。
2. 在下拉菜单中选择 **服务账号**，进入服务账号管理页面。

#### 步骤 3：创建服务账号
1. 在服务账号页面顶部，点击 **创建服务账号** 按钮。
2. 在弹出的窗口中，填写服务账号详情：
   - **服务账号名称**：随意填写，例如 `ClewdR-Vertex-AI`。
   - **服务账号 ID**：自动生成或手动填写，例如 `clewdr-vertex-ai`。
   - **服务账号描述**：可选，填写一些备注信息以便识别，例如“用于 ClewdR 的 Vertex AI 集成”。
3. 点击 **创建并继续** 按钮。

#### 步骤 4：设置角色权限
1. 在角色选择页面，为服务账号分配权限。
2. 在角色下拉菜单中搜索并选择 **Vertex AI Administrator**（Vertex AI 管理员），以确保服务账号有足够的权限访问 Vertex AI 服务。
3. 点击 **继续**，然后点击 **完成** 按钮，完成服务账号创建。

#### 步骤 5：生成 JSON 密钥
1. 创建完成后，你会返回到服务账号列表页面。
2. 找到刚刚创建的服务账号（例如 `ClewdR-Vertex-AI`），点击右侧的 **操作**（通常是三个点图标），选择 **管理密钥**。
3. 在密钥管理页面，点击 **添加密钥**，然后选择 **创建新密钥**。
4. 在弹出的窗口中，选择密钥类型为 **JSON**。
5. 点击 **创建** 按钮，系统会自动下载一个包含密钥的 JSON 文件到你的本地设备。请妥善保存此文件，不要泄露。

#### 步骤 6：复制 JSON 凭证内容
1. 打开下载的 JSON 文件（通常以项目 ID 开头，类似 `your-project-id-123456789.json`）。
2. 使用文本编辑器或直接在文件管理器中查看内容，复制 JSON 文件的**全部内容**（包括大括号 `{}` 内的所有文本）。

#### 步骤 7：将 JSON 凭证配置到 ClewdR
1. 登录到 ClewdR 的管理界面（通常通过浏览器访问 `http://你的IP:8484`）。
2. 在管理界面中，点击 **配置** 选项卡。
3. 找到 **Vertex 设置** 部分，将刚才复制的 JSON 凭证内容粘贴到 **Json 凭证** 文本框中。
4. **模型 ID** 字段可以暂时留空，稍后在酒馆界面选择具体模型。
5. 保存配置。

#### 步骤 8：获取 ClewdR 的代理地址和密码
1. 确保 ClewdR 已在你的服务器上运行（可通过宝塔面板或其他方式启动）。
2. 打开 ClewdR 运行的终端窗口或日志输出，找到显示的 **代理服务器地址**（例如 `http://你的IP:8484/v1/vertex`）和 **API Password**（例如一串随机字符）。
3. 记录下地址和密码，稍后将在酒馆界面中使用。

#### 步骤 9：在酒馆界面配置反向代理
1. 打开酒馆界面。
2. 点击界面中的 **插头** 图标（通常表示连接或设置）。
3. 在弹出的设置菜单中，选择 **聊天补全**，然后点击 **Google AI Studio**。
4. 展开 **反向代理** 设置框，填写以下信息：
   - **代理名称**：填写一个易于识别的名称，例如 `ClewdR-Vertex`。
   - **代理服务器地址**：填写 ClewdR 终端中显示的地址，例如 `http://你的IP:8484/v1/vertex`。请根据实际情况替换 `你的IP`。
   - **代理密码**：填写 ClewdR 终端中显示的 API Password。
5. 确认信息无误后保存设置。

#### 步骤 10：选择模型并测试连接
1. 在酒馆界面的聊天补全设置中，选择一个适合的 Vertex AI 模型（例如 `gemini-pro` 或其他支持的模型）。
2. 点击 **连接** 按钮，建立与 Vertex AI 的连接。
3. 发送一条测试消息，验证连接是否正常。如果收到模型的回复，说明配置成功，enjoy！

#### 注意事项
- **安全警告**：JSON 密钥文件包含敏感信息，请勿将其上传到公共仓库或分享给他人。丢失后可在 Google Cloud 控制台重新生成密钥。
- **权限问题**：如果连接失败，请检查服务账号的角色是否正确设置为 **Vertex AI Administrator**，或者确认 Google Cloud 项目是否已启用 Vertex AI API。
- **网络问题**：确保 ClewdR 服务器与 Google Cloud 之间网络畅通，酒馆与 ClewdR 服务器之间的端口（默认 8484）未被防火墙阻止。
- **模型选择**：不同模型可能有不同的功能和限制，请根据需求选择合适的模型（如文本生成或多模态模型）。

#### 故障排除
- 如果酒馆无法连接到 ClewdR，请检查代理地址和密码是否正确，ClewdR 服务是否正在运行，以及端口是否开放。
- 如果 Vertex AI 返回错误，请检查 Google Cloud 控制台中的 API 配额和计费设置，确保项目未超出限制。
- 日志查看：ClewdR 和酒馆的运行日志中通常会包含详细的错误信息，可帮助排查问题。